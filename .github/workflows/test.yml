name: k6 Load Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Verify k6 installation
        run: k6 version
      
      - name: Run smoke test
        run: k6 run -e ENVIRONMENT=dev tests/smoke/api-smoke.js
        continue-on-error: true
        
      - name: Test Summary
        run: echo "✅ Smoke tests completed"

  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check required files
        run: |
          echo "Checking for required files..."
          test -f README.md && echo "✅ README.md found" || exit 1
          test -f LICENSE && echo "✅ LICENSE found" || exit 1
          test -f CONTRIBUTING.md && echo "✅ CONTRIBUTING.md found" || exit 1
          test -f package.json && echo "✅ package.json found" || exit 1
          test -d config && echo "✅ config/ directory found" || exit 1
          test -d tests && echo "✅ tests/ directory found" || exit 1
          test -d utils && echo "✅ utils/ directory found" || exit 1
          echo "✅ All required files present"
      
      - name: Validate test files
        run: |
          echo "Checking test files..."
          test -f tests/smoke/api-smoke.js && echo "✅ Smoke test found" || exit 1
          test -f tests/load/api-load.js && echo "✅ Load test found" || exit 1
          test -f tests/stress/api-stress.js && echo "✅ Stress test found" || exit 1
          test -f tests/spike/api-spike.js && echo "✅ Spike test found" || exit 1
          test -f tests/soak/api-soak.js && echo "✅ Soak test found" || exit 1
          echo "✅ All test files present"

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check JavaScript syntax
        run: |
          echo "Checking JavaScript files..."
          find . -name "*.js" -not -path "./node_modules/*" -type f -exec node -c {} \;
          echo "✅ All JavaScript files are valid"
